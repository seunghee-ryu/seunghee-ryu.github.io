<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>2020-10-20 TIL - triple S</title>
<meta name="description" content="스레드풀 구현    mini-pms 36">


  <meta name="author" content="Seunghee Ryu">


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="triple S">
<meta property="og:title" content="2020-10-20 TIL">
<meta property="og:url" content="http://localhost:4000/til/TIL201020/">


  <meta property="og:description" content="스레드풀 구현    mini-pms 36">







  <meta property="article:published_time" content="2020-10-20T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/til/TIL201020/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "seunghee ryu",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="triple S Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          triple S
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="https://seunghee-ryu.github.io/">블로그 방문하기</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#til" itemprop="item"><span itemprop="name">Til</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">2020-10-20 TIL</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Seunghee Ryu</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere</span>
        </li>
      

      
        
          
            <li><a href="ryuseunghee.dev@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/seunghee-ryu/seunghee-ryu.github.io" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="2020-10-20 TIL">
    <meta itemprop="description" content="스레드풀 구현  mini-pms 36">
    <meta itemprop="datePublished" content="2020-10-20T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">2020-10-20 TIL
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h1 id="스레드풀-구현">스레드풀 구현</h1>
<ul>
  <li>mini-pms 36</li>
</ul>

<h2 id="스레드풀">스레드풀</h2>
<ul>
  <li>스레드를 풀링 기법(pooling)을 이용하여 관리한다.</li>
  <li>스레드를 사용한 후에 버리지 않고 재사용하여 가비지 생성을 줄인다.</li>
</ul>

<h2 id="풀링-기법pooling">풀링 기법(pooling)</h2>
<ul>
  <li>사용한 객체를 버리지 않고 보관해 두었다가 재사용하는 객체 관리 기법이다.</li>
  <li>동일한 객체를 자주 생성하고,</li>
  <li>생성한 객체를 쓰고 버리는 상황에서 대량의 가비지가 생성되는 경우에 적합한다.</li>
  <li>GoF의 ‘디자인 패턴’에서 Flyweight 패턴의 한 예이다.</li>
</ul>

<h2 id="01-스레드풀-정의">01) 스레드풀 정의</h2>
<ul>
  <li>notify() 와 wait() 는 싱크로되지 않은 곳(막혀있지 않은 곳)에서 사용하면 에러가 뜬다.</li>
  <li>synchronized (대상)</li>
  <li>에외처리</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// try-catch를 while 안에 넣으면 task.run()을 수행하다가 예외가 발생했을 경우 처리할 수 없다.</span>
        <span class="c1">// 스레드는 유효하다.</span>

        <span class="k">try</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"스레드 실행 중 오류 발생"</span><span class="o">);</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>스레드풀 만들기(java.util 따라하기)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPool</span> <span class="o">{</span>

  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

  <span class="c1">// 스레드 + 작업을 맡기고 + 깨우는 기능 + 작업 완료 후 잠자는 기능</span>
  <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="nc">Runnable</span> <span class="n">task</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTask</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 스레드가 할 작업을 배정한 후</span>
      <span class="k">this</span><span class="o">.</span><span class="na">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>

      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 스레드를 깨운다.</span>
        <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>

      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 대기 중...\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 작업 시작\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="c1">// 이 스레드 객체에 대해 대기 상태로 있다가</span>
            <span class="c1">// 이 스레드에게 깨어나라는 알림(notify()/notifyAll()이 온다면</span>
            <span class="c1">// 즉시 runninig 상태로 되돌아간다.</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 실행 중 오류 발생\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 기다리다가 인터럽트 예외가 발생하면 스레드를 종료한다.</span>
          <span class="o">}</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 작업 종료\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - %s\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="c1">// 작업 수행 중 오류가 발생하더라도 스레드는 계속 유효하다.</span>
          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// 정상적인 종료든 작업 수행 중 예외가 발생했든 간에</span>
            <span class="c1">// 작업을 마친 스레드는 재사용할 수 있도록</span>
            <span class="c1">// 다시 목록에 보관되어야 한다.</span>
            <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드풀로 되돌아 감\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">Worker</span> <span class="n">t</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">workers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 만약 스레드가 없다면 스레드를 새로 생성한다.</span>
      <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 생성\n"</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="c1">// 그리고 즉시 실행한다.</span>
      <span class="c1">// - 실행하더라도 스레드 스스로 대기 상태로 갈 것이다.</span>
      <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

      <span class="c1">// 현재 main 스레드를 잠깐 멈추게 하여</span>
      <span class="c1">// 새로 만든 스레드가 실행할 틈을 주자.</span>
      <span class="c1">// 그래야만 새로 만든 스레드가 실행하자마자 대기 상태로 간다.</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// sleep() 중 발생한 예외는 무시한다.</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// 만약 스레드가 있다면 스레드풀에서 스레드를 한 개 꺼낸다.</span>
      <span class="c1">// - 스레드풀에서 꺼낸 스레드는 현재 대기 상태이다.</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 재사용\n"</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 스레드를 깨워서 일을 시킨다.</span>
    <span class="c1">// - 스레드에게 해야 할 작업을 배정하면 된다.</span>
    <span class="n">t</span><span class="o">.</span><span class="na">setTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="02-클라이언트가-접속하면-요청-처리를-threadpool에게-맡긴다">02) 클라이언트가 접속하면 요청 처리를 ThreadPool에게 맡긴다.</h2>
<ul>
  <li>같은 코드인데 정상 실행이 됐다가 안됐다가 하는것은 비동기 때문이다.
    <ul>
      <li>비동기에서는 누가 먼저 실행되는지 정확하게 알아야 한다.</li>
    </ul>
  </li>
  <li>소켓은 클라이언트가 연결되었다가 끊어지는 순간에 사라지기 때문에 재사용이 불가능하다.</li>
  <li>스레드가 몇개의 작업을 처리할 수 있는지는 컴퓨터의 cpu 성능에 따라 다르다.</li>
  <li>스레드를 몇개 생성할 수 있는지는 메모리에 따라 다르다.</li>
  <li>메인 스레드가 죽어도 나머지 스레드(스레드풀)가 살아 있으면 종료되지 않는다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerApp</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

  <span class="c1">// 스레드풀 준비</span>
  <span class="nc">ThreadPool</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPool</span><span class="o">();</span>

  <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Hashtable</span><span class="o">&lt;&gt;();</span>

  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ApplicationContextListener</span><span class="o">&gt;</span> <span class="n">listeners</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addApplicationContextListener</span><span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeApplicationContextListener</span><span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyApplicationContextListenerOnServiceStarted</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">listener</span><span class="o">.</span><span class="na">contextInitialized</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyApplicationContextListenerOnServiceStopped</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">listener</span><span class="o">.</span><span class="na">contextDestroyed</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">service</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">notifyApplicationContextListenerOnServiceStarted</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">(</span><span class="nc">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"서버 실행 중..."</span><span class="o">);</span>

      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">clientSocket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">stop</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 스레드풀로 변경</span>
        <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">handleClient</span><span class="o">(</span><span class="n">clientSocket</span><span class="o">));</span>
      <span class="o">}</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">notifyApplicationContextListenerOnServiceStopped</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="03-스레드풀">03) 스레드풀</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.eomcs.util.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPool</span> <span class="o">{</span>

  <span class="c1">// 스레드풀의 종료 상태</span>
  <span class="kt">boolean</span> <span class="n">stopping</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

  <span class="c1">// 스레드 목록을 담는 리스트</span>
  <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

  <span class="c1">// 작업을 수행하는 스레드</span>
  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="nc">Runnable</span> <span class="n">task</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTask</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>

            <span class="c1">// 스레드풀의 상태가 종료하는 상태라면, 스레드 실행을 멈춘다.</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">stopping</span><span class="o">)</span>
              <span class="k">break</span><span class="o">;</span>

            <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"스레드풀로 되돌아 감!"</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s 스레드에서 오류 발생! - 스레드풀에서 제거.\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
          <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Worker</span> <span class="n">t</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">workers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">();</span>
      <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"새 스레드(%s) 생성 및 실행!\n"</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"기존 스레드(%s) 사용!\n"</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="n">t</span><span class="o">.</span><span class="na">setTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">stopping</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

      <span class="c1">// 일단 현재 목록에 대기하고 있는 스레드를 종료한다.</span>
      <span class="k">while</span> <span class="o">(!</span><span class="n">workers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">worker</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="c1">// 아직 클라이언트의 요청 처리를 완료하지 못한 스레드를 기다린다.</span>
      <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>

      <span class="c1">// 다시 현재 목록에 대기하고 있는 스레드를 종료한다.</span>
      <span class="k">while</span> <span class="o">(!</span><span class="n">workers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">worker</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"스레드풀 종료 중 오류 발생!"</span><span class="o">);</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>내가 타이핑한거.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPool</span> <span class="o">{</span>

  <span class="c1">// 스레드풀의 종료 상태</span>
  <span class="kt">boolean</span> <span class="n">stopping</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

  <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="nc">Runnable</span> <span class="n">task</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTask</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>

      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>

      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 대기 중...\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">stopping</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 스레드풀이 종료 상태라면</span>
              <span class="c1">// 스레드는 깨어나는 즉시 실행을 멈춘다.</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 작업 시작\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 실행 중 오류 발생\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 작업 종료\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - %s\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드풀로 되돌아 감\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">stopping</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// RuntimeException을 사용하면 public void execute(Runnable task) 에서 예외를 던지지 않아도 된다.</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"스레드풀이 종료 상태입니다."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">Worker</span> <span class="n">t</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">workers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 생성\n"</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] - 스레드 재사용\n"</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="n">t</span><span class="o">.</span><span class="na">setTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">stopping</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

      <span class="k">while</span> <span class="o">(!</span><span class="n">workers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 스레드풀에 대기 중인 스레드가 있다면</span>
        <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// 맨 앞에 있는 스레드를 꺼내서</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// 스레드를 깨운다.</span>
          <span class="c1">// 스레드는 깨어나면 stopping 상태에 따라 종료 여부를 결정하도록 프로그래밍 되어있다.</span>
          <span class="c1">// worker 스레드를 보라.</span>
          <span class="n">worker</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="c1">// 아직 스레드풀에서 대기하지 않고 현재 작업을 수행하는 스레드가 있을 수 있다.</span>
      <span class="c1">// 그 스레드가 작업을 끝낼 때까지 좀 기다리자</span>
      <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>

      <span class="c1">// 다시 한 번 대기하고 있는 스레드를 종료해보자.</span>
      <span class="k">while</span> <span class="o">(!</span><span class="n">workers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 스레드풀에 대기 중인 스레드가 있다면</span>
        <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// 맨 앞에 있는 스레드를 꺼내서</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// 스레드를 깨운다.</span>
          <span class="c1">// 스레드는 깨어나면 stopping 상태에 따라 종료 여부를 결정하도록 프로그래밍 되어있다.</span>
          <span class="c1">// worker 스레드를 보라.</span>
          <span class="n">worker</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>


      <span class="c1">// 예외 처리를 한다.</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"스레드풀을 종료하는 중에 예외 발생"</span><span class="o">);</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="36-b">36-b</h1>

<h2 id="스레드풀을-자바에서-제공하는-것으로-변경">스레드풀을 자바에서 제공하는 것으로 변경</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerApp</span> <span class="o">{</span>

  <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

  <span class="c1">// 스레드풀 준비</span>
  <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>

  <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Hashtable</span><span class="o">&lt;&gt;();</span>

  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ApplicationContextListener</span><span class="o">&gt;</span> <span class="n">listeners</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addApplicationContextListener</span><span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeApplicationContextListener</span><span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyApplicationContextListenerOnServiceStarted</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">listener</span><span class="o">.</span><span class="na">contextInitialized</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyApplicationContextListenerOnServiceStopped</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationContextListener</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">listeners</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">listener</span><span class="o">.</span><span class="na">contextDestroyed</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">service</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">notifyApplicationContextListenerOnServiceStarted</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">(</span><span class="nc">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"서버 실행 중..."</span><span class="o">);</span>

      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">clientSocket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">stop</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">handleClient</span><span class="o">(</span><span class="n">clientSocket</span><span class="o">));</span>
      <span class="o">}</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">notifyApplicationContextListenerOnServiceStopped</span><span class="o">();</span>

    <span class="c1">// 스레드풀을 종료한다.</span>
    <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>

    <span class="c1">// 스레드풀을 종료한다.</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">threadPool</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"아직 종료 안된 작업이 있다."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"남아 있는 작업의 강제 종료를 시도하겠다."</span><span class="o">);</span>
        <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">threadPool</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"스레드풀의 강제 종료를 완료하지 못했다."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"모든 작업을 강제 종료했다."</span><span class="o">);</span>
        <span class="o">}</span>

      <span class="o">}</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"main() 종료!"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 예외는 무시한다.</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="dbms">DBMS</h1>

<h2 id="개발자가-직접-데이터-관리를-위해-파일을-조작할-때">개발자가 직접 데이터 관리를 위해 파일을 조작할 때</h2>
<ul>
  <li>임의의 위치에 있는 값을 변경?</li>
  <li>특정 조건에 해당하는 데이터를 찾기?</li>
  <li>특정 조건의 데이터 삭제?</li>
  <li>대량의 데이터를 다루기 쉽게 어떤 기법으로 여러 파일로 분산할 것이냐?</li>
  <li>데이터와 데이터 간의 관계를 어떻게 관리할 것이냐?</li>
  <li>유효하지 않은 데이터 조작
    <ul>
      <li>많은 코딩, 중복 개발 =&gt; Data 관리 전문 S/W =&gt; DBMS</li>
      <li>상용으로 쓸 수 없다.</li>
    </ul>
  </li>
</ul>

<h2 id="dbms-1">DBMS</h2>
<ul>
  <li>데이터 관리 전문 소프트웨어</li>
  <li>DataBase Management System</li>
  <li>예)
    <ul>
      <li>(외산) Oracle, My-SQL, MS-SQL, DB2,</li>
      <li>(국산) Altibase, Cubrid, Tibero</li>
      <li>MariaDB &lt;- My-SQL 창시자</li>
    </ul>
  </li>
  <li>Relational DBMS -&gt; 데이터와 데이터 사이의 관계를 다루기 쉽게
    <ul>
      <li>Object-Relational
        <ul>
          <li>O-RDBMS -&gt; PostgreSQL</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>NoSQL-DBMS
    <ul>
      <li>MongoDB &lt;- BigData : 자잘하게 갯수가 많은 데이터</li>
      <li>https://poiemaweb.com/mongdb-basics</li>
      <li>서로 연관이 없으면서 데이터 불륨이 큰 빅데이터를 다루기 위해서 사용한다.</li>
    </ul>
  </li>
  <li>Data 저장 / 조회</li>
  <li>임의의 위치에 있는 Data 변경 / 삭제 / 검색</li>
  <li>Client 인증 / 권한 관리</li>
  <li>Data 간의 관계를 제어
    <ul>
      <li>-&gt; 결함이 생기지 않게 제어(무결성 Integrity)</li>
    </ul>
  </li>
</ul>

<h2 id="dbms-와-sql">DBMS 와 SQL</h2>
<ul>
  <li>https://zzsza.github.io/development/2018/03/18/sql-for-everyone/</li>
  <li>https://brunch.co.kr/@minu-log/5</li>
  <li>DBMS 와 Client 의 통신에서 명령을 작성하는 문법이 SQL 이다.</li>
  <li>Structured Query Language</li>
  <li>특정 DBMS로부터 독립적으로 사용한다.</li>
  <li>Select, From, Where, Group by, Having, Limit</li>
</ul>

<h2 id="표준-sql--α">표준 SQL + α</h2>
<ul>
  <li>버젼별 표준 문법이 있다.</li>
  <li>DBMS 마다 지원하는 버젼에 차이가 있다.
    <ul>
      <li>모든 DBMS 가 SQL 표준을 완벽하게 지원하지 못한다.</li>
      <li>또는 DBMS 마다 지원하는 SQL 버젼도 다르다</li>
      <li>같은 DBMS라도 버젼마다 지원하는 SQL 버젼이 다르다.
        <ul>
          <li>-&gt; 개발자는 사용할 DBMS에 맞춰 SQL을 작성해야 한다.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="sql-과-개발-현실">SQL 과 개발 현실</h2>
<ul>
  <li>SQL 문 = 표준 SQL + DBMS 전용 문법
    <ul>
      <li>-&gt; 1) 같은 Vendor의 DBMS(같은 제품)라 하더라도 버젼마다 사용할 수 있는 문법이 차이가 난다.</li>
      <li>-&gt; 2) DBMS가 다른 Vendor의 제품이라면 전용 문법이 다르기 때문에 동작이 안될 수 있다.</li>
    </ul>
  </li>
  <li>-&gt; 그렇다면 표준 SQL을 사용?
    <ul>
      <li>DBMS 마다 사용 가능한 문법이 다를 수 있다.</li>
      <li>DBMS 전용 문법은 DBMS 성능을 극한으로 이용
        <ul>
          <li>-&gt; 표준 SQL만 사용하면 이런 이점을 누릴 수 없다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>개발자는 DBMS 상황에 맞춰 SQL을 변경해줘야한다.</li>
</ul>

<h2 id="dbms-설치-eomcs-docs-dbms">DBMS 설치 (eomcs-docs-dbms)</h2>
<ul>
  <li>MariaDB &lt;-&gt; (접속하는 프로그램) MySql</li>
  <li>MariaDB 설치</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[windows OS]
scoop 패키지 관리자를 이용하여 mariadb 설치
&gt; scoop install mariadb

서비스에 등록 
    mysqld --install "서비스명"
&gt; mysqld --install "mariadb"

서비스 시작 
    net start 서비스명
&gt; net start mariadb    (windows)

서비스 종료
    net stop 서비스명
&gt; net stop mariadb

[mac]
mariadb 설치
&gt; brew install mariadb

mariadb 실행
&gt; brew services start mariadb
&gt; brew services stop mariadb
또는
&gt; mysql.server start
&gt; mysql.server stop

[linux]
mariadb 설치
&gt; sudo apt update
&gt; sudo apt install mariadb-server
&gt; sudo systemctl status mariadb
&gt; mysql -V

mariadb 설치 후 root 암호 변경
&gt; sudo mysql_secure_installation

mariadb 실행
&gt; service mariadb start
&gt; service mariadb stop
&gt; service mariadb status
</code></pre></div></div>
<ul>
  <li>mysql 서버에 접속하기
로컬 MySQL 서버에 접속
    <blockquote>
      <p>mysql -u root -p
Enter password: 암호입력</p>
    </blockquote>
  </li>
</ul>

<p>원격 MySQL 서버에 접속</p>
<blockquote>
  <p>mysql -h 서버주소 -u root -p
Enter password: 암호입력</p>
</blockquote>

<ul>
  <li>mysql root 암호 변경
    <blockquote>
      <p>alter user ‘root’@’localhost’ identified by ‘1111’;</p>
    </blockquote>
  </li>
  <li>MySQL 사용자 추가
    <blockquote>
      <p>CREATE USER ‘사용자아이디’@’서버주소’ IDENTIFIED BY ‘암호’;</p>
    </blockquote>
  </li>
</ul>

<p>로컬에서만 접속할 수 있는 사용자를 만들기:</p>
<blockquote>
  <p>CREATE USER ‘study’@’localhost’ IDENTIFIED BY ‘1111’;
  =&gt; 이 경우 stidu 사용자는 오직 로컬(서버를 실행하는 컴퓨터)에서만 접속 가능한다.
  =&gt; 다른 컴퓨터에서 실행하는 MySQL 서버에 접속할 수 없다는 것을 의미한다.</p>
</blockquote>

<p>원격에서만 접속할 수 있는 사용자를 만들기:</p>
<blockquote>
  <p>CREATE USER ‘study’@’%’ IDENTIFIED BY ‘1111’;
  =&gt; 이 경우 study 사용자는 원력에서만 접속 가능하다.</p>
</blockquote>

<ul>
  <li>MySQL 사용자 목록 조회
    <blockquote>
      <p>select user, host from 데이터베이스명.테이블명;
select user, host from mysql.user;</p>
    </blockquote>
  </li>
  <li>MySQL 데이터베이스 생성
mariadb에서는 default 키워드를 사용하지 않는다.
    <blockquote>
      <p>CREATE DATABASE 데이터베이스명
CHARACTER SET utf8
COLLATE utf8_general_ci;</p>
    </blockquote>
  </li>
</ul>

<blockquote>
  <p>CREATE DATABASE studydb
  CHARACTER SET utf8
  COLLATE utf8_general_ci;</p>
</blockquote>

<ul>
  <li>MySQL 사용자에게 데이터베이스 사용 권한 부여
    <blockquote>
      <p>GRANT ALL ON 데이터베이스명.* TO ‘사용자아이디’@’서버주소’;
GRANT ALL ON studydb.* TO ‘study’@’localhost’;</p>
    </blockquote>
  </li>
  <li>데이터베이스 목록 조회
    <blockquote>
      <p>show databases;</p>
    </blockquote>
  </li>
  <li>사용자 교체
    <blockquote>
      <p>quit or exit  (프로그램 종료 후)
mysql -u study -p   (다시 실행)</p>
    </blockquote>
  </li>
  <li>기본으로 사용할 데이터베이스 지정하기
    <blockquote>
      <p>use 데이터베이스명
use studydb;</p>
    </blockquote>
  </li>
  <li>데이터베이스의 전체 테이블 목록 조회
    <blockquote>
      <p>show tables;</p>
    </blockquote>
  </li>
  <li>연습
```
사용자 생성 : user1
user1이 사용할 데이터베이스 생성: user1db</li>
</ul>

<p>사용자 생성 : user2
user1이 사용할 데이터베이스 생성: user2db</p>

<p>사용자 생성 : user3
user1이 사용할 데이터베이스 생성: user3db</p>

<p>사용자 생성 : user4
user1이 사용할 데이터베이스 생성: user4db</p>

<p>사용자 생성 : user5
user1이 사용할 데이터베이스 생성: user5db</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- mariadb 인스톨과 설정
</code></pre></div></div>
<p>✘ rsh@rsh  ~
 brew service stop mariadb
Error: Unknown command: service
 ✘ rsh@rsh  ~
 brew services stop mariadb
Stopping <code class="language-plaintext highlighter-rouge">mariadb</code>… (might take a while)
==&gt; Successfully stopped <code class="language-plaintext highlighter-rouge">mariadb</code> (label: homebrew.mxcl.mariadb)
 rsh@rsh  ~
 brew services start mariadb
==&gt; Successfully started <code class="language-plaintext highlighter-rouge">mariadb</code> (label: homebrew.mxcl.mariadb)
 rsh@rsh  ~
 mysql -u root -p
Enter password: 
ERROR 1698 (28000): Access denied for user ‘root’@’localhost’
 ✘ rsh@rsh  ~
 sudo mysql_secure_installation
Password:
Sorry, try again.
Password:</p>

<p>NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</p>

<p>In order to log into MariaDB to secure it, we’ll need the current
password for the root user. If you’ve just installed MariaDB, and
haven’t set the root password yet, you should just press enter here.</p>

<p>Enter current password for root (enter for none): 
OK, successfully used password, moving on…</p>

<p>Setting the root password or using the unix_socket ensures that nobody
can log into the MariaDB root user without the proper authorisation.</p>

<p>You already have your root account protected, so you can safely answer ‘n’.</p>

<p>Switch to unix_socket authentication [Y/n] n
 … skipping.</p>

<p>You already have your root account protected, so you can safely answer ‘n’.</p>

<p>Change the root password? [Y/n] y
New password: 
Re-enter new password: 
Password updated successfully!
Reloading privilege tables..
 … Success!</p>

<p>By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.</p>

<p>Remove anonymous users? [Y/n] y
 … Success!</p>

<p>Normally, root should only be allowed to connect from ‘localhost’.  This
ensures that someone cannot guess at the root password from the network.</p>

<p>Disallow root login remotely? [Y/n] y
 … Success!</p>

<p>By default, MariaDB comes with a database named ‘test’ that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.</p>

<p>Remove test database and access to it? [Y/n] y</p>
<ul>
  <li>Dropping test database…
 … Success!</li>
  <li>Removing privileges on test database…
 … Success!</li>
</ul>

<p>Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.</p>

<p>Reload privilege tables now? [Y/n] y
 … Success!</p>

<p>Cleaning up…</p>

<p>All done!  If you’ve completed all of the above steps, your MariaDB
installation should now be secure.</p>

<p>Thanks for using MariaDB!
 rsh@rsh  ~
 brew services stop mariadb
Stopping <code class="language-plaintext highlighter-rouge">mariadb</code>… (might take a while)
==&gt; Successfully stopped <code class="language-plaintext highlighter-rouge">mariadb</code> (label: homebrew.mxcl.mariadb)
 rsh@rsh  ~
 mysql -u root -p
Enter password: 
ERROR 2002 (HY000): Can’t connect to local MySQL server through socket ‘/tmp/mysql.sock’ (2)
 ✘ rsh@rsh  ~
 brew services start mariadb <br />
==&gt; Successfully started <code class="language-plaintext highlighter-rouge">mariadb</code> (label: homebrew.mxcl.mariadb)
 rsh@rsh  ~
 mysql -u root -p         <br />
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 3
Server version: 10.5.6-MariaDB Homebrew</p>

<p>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</p>

<p>Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement.</p>

<p>MariaDB [(none)]&gt;
```</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#til" class="page__taxonomy-item" rel="tag">TIL</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2020-10-20T00:00:00+09:00">October 20, 2020</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pms/mini-pms-33b/" class="pagination--pager" title="mini-pms 33b
">이전</a>
    
    
      <a href="/pms/mini-pms-36a/" class="pagination--pager" title="mini-pms 36 a
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">참고</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/til/TIL201026/" rel="permalink">2020-10-26 TIL
</a>
      
    </h2>
    


    <p class="archive__item-excerpt" itemprop="description">stateful, stateless

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/til/TIL201023/" rel="permalink">2020-10-23 TIL
</a>
      
    </h2>
    


    <p class="archive__item-excerpt" itemprop="description">커밋 메시지 스타일 가이드

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/til/TIL201022/" rel="permalink">2020-10-22 TIL
</a>
      
    </h2>
    


    <p class="archive__item-excerpt" itemprop="description">챗봇 기반 방탈출 게임 만들기

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/til/TIL201021/" rel="permalink">2020-10-21 TIL
</a>
      
    </h2>
    


    <p class="archive__item-excerpt" itemprop="description">MariaDB, MySQL

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 seunghee ryu. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>









  </body>
</html>
