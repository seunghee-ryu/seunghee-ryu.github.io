---
layout : post
title :  2020-11-12 TIL
categories : TIL
layout : single
toc : true 
toc_sticky : true
---

# Dynamic sql
- https://mybatis.org/mybatis-3/ko/dynamic-sql.html

## 조건에 따라 sql을 바꾸는 문법

### choose
- 상호배타적이다.
    - 하나의 조건이 선택되면 나머지는 배제된다.
    - 상호배타적인 조건을 걸거라면 if 보다 낫다.
- 사용법

```java
  <select id="select21" resultMap="BoardMap" parameterType="map">
    select 
      board_id,
      title, 
      contents, 
      created_date,
      view_count 
    from x_board
    where
    <choose>
	    <when test="item == 'no'">
	      board_id = #{keyword}
	    </when>
	    <when test='item == "title"'>
	      title like concat('%', #{keyword}, '%')
	    </when>
	    <otherwise>
	      contents like concat('%', #{keyword}, '%')
	    </otherwise>
	  </choose>
  </select> 
```

- """" 이나 '''' 은 불가능하다
- "''" 이나 '""' 은 가능하다.
- 파라미터로 넘어오는 객체에서 해당 이름으로 값을 꺼내서 값과 문자열을 비교한다. 이때 문자열로 비교하고 싶을때는 "" 을 써야한다.
- 숫자일 경우에는 "''"이 안된다.
- 문자일 경우에는 "''"이 된다.
    - 추천 : 무조건 '""'을 사용하라.

### set
- set 태그는 set 이라는 sql 문을 만들면서 항목이 하나인데 앞이나 뒤에 , 가 있을 경우 , 를 자동으로 제거한다.

```java
  <update id="update4" parameterType="map">
    update x_board 
    <set>
      <if test="title != null">title=#{title},</if>   
      <if test="content != null">contents=#{content}</if>  
    </set> 
    where board_id=#{no}
  </update>
```

### foreach
- 값을 arrayList에 담아서 그 arrayList를 맵에 담아서 맵을 넘겨준다.
- where 태그가 앞뒤에 있는 or를 자동으로 제거한다.

```java
    ArrayList<Object> noList = new ArrayList<>();
    for (String value : values) {
      noList.add(value);
    }
    params.put("noList", noList);
```

- 빈문자열을 스플릿하면 빈문자열도 문자열로 취급해서 배열이 하나 생성되는 것이 된다.
- 

```java
  <select id="select23" resultMap="BoardMap" parameterType="map">
    select 
      board_id,
      title, 
      contents, 
      created_date,
      view_count 
    from x_board
    <where>
      <foreach collection="noList" item="no">
      <if test="no != ''">
        or board_id = #{no}
        </if>
      </foreach>
    </where>
  </select>
```

#### 주석

```java
  <select id="select24" resultMap="BoardMap" parameterType="map">
    select 
      board_id,
      title, 
      contents, 
      created_date, <!-- xml, html 주석이라 sql 문을 만들때는 사라진다. -->
      view_count /* sql 주석이기 때문에 포함되어 DB로 옮겨진다. */
    from x_board
    <where>
      board_id in /* (1, 2, 11, 12) */
      <foreach collection="noList" item="no" open="(" separator="," close=")">
        #{no}
      </foreach>
    </where>
  </select>
```

### bind

```java
  <select id="select26" resultMap="BoardMap" parameterType="map">
    <bind name="titlePattern" value="'%' + _parameter.title + '%'"/>
    select 
      board_id,
      title, 
      contents, 
      created_date,
      view_count
    from x_board
    <where>
        title like #{titlePattern}
    </where>
  </select>
</mapper>
```