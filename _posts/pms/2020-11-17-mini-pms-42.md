---
layout: post
title:  "mini-pms 42"
categories: PMS
layout : single
toc : true 
toc_sticky : true
---

# 42. 비즈니스 로직 분리하기 : 서비스 객체의 도입

### 1단계 - 프로젝트 삭제 Command 객체에서 업무 코드를 분리한다.

커맨드 객체에서 비즈니스 로직을 분리하여 서비스 객체에 옮긴다.

- com.eomcs.pms.service.ProjectService 인터페이스 생성
  - 서비스 객체의 메서드 명은 보통 업무 관련 용어를 사용한다.
  - DAO 객체의 메서드 명은 데이터 관련 용어를 사용한다.
  - `delete()` 메서드 선언

```java
public interface ProjectService {
  int delete(int projectNo) throws Exception;

}
```

- com.eomcs.pms.service.DefaultProjectService 클래스 생성
  - `delete()` 메서드 구현
    - `ProjectDeleteCommand` 에서 비즈니스 로직과 관련된 코드를 가져온다.

```java
public class DefaultProjectService implements ProjectService {

  ProjectDao projectDao;
  TaskDao taskDao;
  SqlSessionFactoryProxy factoryProxy;

  public DefaultProjectService(
      ProjectDao projectDao,
      TaskDao taskDao,
      SqlSessionFactoryProxy factoryProxy) {
    this.projectDao = projectDao;
    this.taskDao = taskDao;
    this.factoryProxy = factoryProxy;
  }


  @Override
  public int delete(int no) throws Exception {
    try {
      // 트랜잭션 시작
      factoryProxy.startTransaction();
      // 프로젝트에 소속된 모든 작업 삭제하기
      taskDao.deleteByProjectNo(no);
      // 프로젝트 삭제하기
      int count = projectDao.delete(no);
      // 트랜잭션 작업이 성공하였다면 커밋
      factoryProxy.commit();
      return count;

    } catch (Exception e) {
      // 트랜잭션 작업 도중에 예외가 발생하면 롤백
      factoryProxy.rollback();
      // 서비스 객체에서 발생한 예외는 호출자에게 전달한다.
      throw e;

    } finally {
      // 트랜잭션 종료
      factoryProxy.endTransaction();
    }
  }
}
```

- com.eomcs.pms.handler.ProjectDeleteCommand 클래스 변경
  - `ProjectService` 구현체를 사용하여 프로젝트 삭제 처리

```java
public class ProjectDeleteCommand implements Command {

  ProjectService projectService;

  public ProjectDeleteCommand(ProjectService projectService) {
    this.projectService = projectService;
  }

  @Override
  public void execute(Map<String,Object> context) {
    System.out.println("[프로젝트 삭제]");
    int no = Prompt.inputInt("번호? ");

    String response = Prompt.inputString("정말 삭제하시겠습니까?(y/N) ");
    if (!response.equalsIgnoreCase("y")) {
      System.out.println("프로젝트 삭제를 취소하였습니다.");
      return;
    }

    try {

      if (projectService.delete(no) == 0) {
        System.out.println("해당 번호의 프로젝트가 존재하지 않습니다.");
        return;
      }
      System.out.println("프로젝트를 삭제하였습니다.");

    } catch (Exception e) {
      System.out.println("프로젝트 삭제 중 오류 발생!");
      e.printStackTrace();
    }
  }
}
```

### 2단계 - 프로젝트 삭제 DAO 객체에서 업무 코드를 분리한다.

DAO 객체에서 비즈니스 로직을 분리하여 서비스 객체에 옮긴다.

- com.eomcs.pms.dao.ProjectDao 인터페이스 변경
  - `deleteMembers()` 메서드 선언 추가

```java
public interface ProjectDao {
  int insert(Project project) throws Exception;
  int delete(int no) throws Exception;
  Project findByNo(int no) throws Exception;
  List<Project> findAll() throws Exception;
  List<Project> findByKeyword(String item, String keyword) throws Exception;
  List<Project> findByDetailKeyword(Map<String,Object> keywords) throws Exception;
  int update(Project project) throws Exception;

  int deleteMembers(int PorjectNo) throws Exception;
}
```

- com.eomcs.pms.dao.mariadb.ProjectDaoImpl 클래스 변경
  - `delete()` 메서드에서 멤버 삭제 관련 코드를 별도의 메서드 `deleteMembers()` 로 분리한다.

```java
public class ProjectDaoImpl implements com.eomcs.pms.dao.ProjectDao {
.
.
.
  @Override
  public int delete(int no) throws Exception {
    try (SqlSession sqlSession = sqlSessionFactory.openSession()) {
      // 프로젝트를 삭제한다.
      return sqlSession.delete("ProjectDao.delete", no);
    }
  }
.
.
.
  @Override
  public int deleteMembers(int projectNo) throws Exception {
    try (SqlSession sqlSession = sqlSessionFactory.openSession()) {
      // 프로젝트에 소속된 모든 멤버를 삭제한다.
      return sqlSession.delete("ProjectDao.deleteMembers", projectNo);
    }
  }
}
```

- com.eomcs.pms.service.DefaultProjectService 클래스 변경
  - `delete()` 메서드 변경
    - 프로젝트 멤버를 삭제하는 `deleteMembers()` 를 호출한다.

```java
public class DefaultProjectService implements ProjectService {
.
.
.
  @Override
  public int delete(int no) throws Exception {
    try {
      // 트랜잭션 시작
      factoryProxy.startTransaction();
      // 프로젝트에 소속된 모든 작업 삭제하기
      taskDao.deleteByProjectNo(no);
      // 프로젝트에 소속된 모든 멤버 삭제하기
      projectDao.deleteMembers(no);
      // 프로젝트 삭제하기
      int count = projectDao.delete(no);
      // 트랜잭션 작업이 성공하였다면 커밋
      factoryProxy.commit();
      return count;

    } catch (Exception e) {
      // 트랜잭션 작업 도중에 예외가 발생하면 롤백
      factoryProxy.rollback();
      // 서비스 객체에서 발생한 예외는 호출자에게 전달한다.
      throw e;

    } finally {
      // 트랜잭션 종료
      factoryProxy.endTransaction();
    }
  }
}
```

### 3단계 - 프로젝트 등록 커맨드 객체에서 비즈니스 로직을 분리한다.

- com.eomcs.pms.dao.ProjectDao 인터페이스 변경
  - `insertMembers()` 메서드 선언 추가

```java
public interface ProjectDao {
  int insert(Project project) throws Exception;
  int delete(int no) throws Exception;
  Project findByNo(int no) throws Exception;
  List<Project> findAll() throws Exception;
  List<Project> findByKeyword(String item, String keyword) throws Exception;
  List<Project> findByDetailKeyword(Map<String,Object> keywords) throws Exception;
  int update(Project project) throws Exception;

  int deleteMembers(int PorjectNo) throws Exception;
  int insertMembers(Project project) throws Exception;
}
```

- com.eomcs.pms.dao.mariadb.ProjectDaoImpl 클래스 변경
  - `insert()` 메서드에서 비즈니스 로직을 추출하여 별도의 메서드 `insertMembers()` 로 옮긴다.

```java
public class ProjectDaoImpl implements com.eomcs.pms.dao.ProjectDao {

  SqlSessionFactory sqlSessionFactory;

  public ProjectDaoImpl(SqlSessionFactory sqlSessionFactory) {
    this.sqlSessionFactory = sqlSessionFactory;
  }

  @Override
  public int insert(Project project) throws Exception {
    try (SqlSession sqlSession = sqlSessionFactory.openSession()) {
      // 프로젝트 정보 입력
      return sqlSession.insert("ProjectDao.insert", project);
    }
  }
.
.
.
  @Override
  public int insertMembers(Project project) throws Exception {
    try (SqlSession sqlSession = sqlSessionFactory.openSession()) {
      // 프로젝트의 멤버 정보 입력
      return sqlSession.insert("ProjectDao.insertMembers", project);
    }
  }
}
```

- com.eomcs.pms.service.ProjectService 인터페이스 생성
  - `add()` 메서드 선언

```java
public interface ProjectService {
  int delete(int projectNo) throws Exception;
  int add(Project project) throws Exception;
}
```

- com.eomcs.pms.service.DefaultProjectService 클래스 생성
  - `add()` 메서드 구현
    - `ProjectAddCommand` 에서 비즈니스 로직과 관련된 코드를 가져온다.

```java
public class DefaultProjectService implements ProjectService {
.
.
.
  @Override
  public int add(Project project) throws Exception {
    projectDao.insert(project);
    return 1;
  }
}
```
- project를 insert할 때 memberDao를 사용하기 때문에
- com.eomcs.pms.service.MemberService 인터페이스 생성
  - `list()` 메서드 선언

```java
public interface MemberService {
    // findByName 이기 때문에 이름을 리스트로 리턴한다.
  List<Member> list(String name) throws Exception;
}
```
- com.eomcs.pms.service.DefaultMemberService 인터페이스 생성
  - `list()` 메서드 구현

```java
public interface MemberDao {
  int insert(Member member) throws Exception;
  int delete(int no) throws Exception;
  Member findByNo(int no) throws Exception;
  List<Member> findByName(String name) throws Exception;
  List<Member> findAll() throws Exception;
  int update(Member member) throws Exception;
  List<Member> findByProjectNo(int projectNo) throws Exception;
  Member findByEmailPassword(String email, String password) throws Exception;
}

public class DefaultMemberService implements MemberService {

  MemberDao memberDao;

  public DefaultMemberService(MemberDao memberDao) {
    this.memberDao = memberDao;
  }

  @Override
  public List<Member> list(String name) throws Exception {
    return memberDao.findByName(name);
  }
}
```

- com.eomcs.pms.service.MemberDao 인터페이스 변경
  - `findByName()` 의 리턴 값을 `List` 객체로 변경한다.
- com.eomcs.pms.service.MemberDaoImpl 클래스 변경
  - `findByName()` 의 리턴 값을 `List` 객체로 변경한다.
- com.eomcs.pms.handler.ProjectAddCommand 클래스 변경
  - `MemberService` 구현체를 사용하여 멤버 찾기
  - `ProjectService` 구현체를 사용하여 프로젝트 등록 처리